# Задача коммивояжера (Travelling salesman problem)

## Постановка задачи
Имеется N городов, связанных дорогами. Расстояния между городами известны. Коммивояжер (бродячий торговец) должен выйти из первого города, посетить по одному разу в 
некотором порядке города 2,3..n и вернуться в первый город. В каком порядке следует посещать города, чтобы замкнутый путь коммивояжера имел кратчайшее расстояние?

### Вариант 6:

Решить задачу коммивояжера с применением генетического алгоритма, с учетом следующих требований:
   - Придумать условия задачи с количеством городов не менее 8.
   - Численность популяции не менее 4 особей, в скрещивании участвует половина популяции. 
   - Для скрещивания выбираются сильнейшие особи, скрещивание – одноточечное.
   - До выполнения алгоритма сформулировать стратегию применения оператора мутации.
   - Для скрещивания и мутации использовать альтернативную кодировку особей.
   - Для альтернативной кодировки отобранных особей и декодировки полученных потомков оформить подробные пошаговые комментарии.
   - Сформировать не менее 3 поколений, не считая первоначального.

## Условия задачи
Матрица расстояний: 

|       | **1** | **2** | **3** | **4** | **5** | **6** | **7** | **8** |
|:------|:-----:|:-----:|:-----:|:-----:|:-----:|-------|-------|-------|
| **1** | **∞** |   3   |   7   |   4   |   12   | 7    | 6     | 23    |
| **2** |   12  | **∞** |   5   |  4    |   6   | 8     | 6     | 24    |
| **3** |   1   |   3   | **∞** |   4   |  12   | 23    | 6     | 5     |
| **4** |  11   |   33  |   45  | **∞** |   9   | 7     | 6     | 24    |
| **5** |   133 |  13   |   5   |   4   | **∞** | 7     | 4     | 81    | 
| **6** |   1   |   31  |  25   |   5   |   24  | **∞** | 86    | 24    |
| **7** |   41  |   3   |   5   |   4   |   2   | 78    | **∞** | 3     |
| **8** |   5   |   12  |  5    |   44  |   22  |  7    | 6     | **∞** |

##### Стратегия применения мутации:
Мутация применяется, если: 
1) мутация происходит в 50% случаев;
2) хромосомы новых особей идентичны родительским.

### Начальная популяция:
Сформируем начальную популяцию (N=4). Для этого случайным образом составим замкнутые маршруты, начинающиеся в вершине 1.

|        | 1 | 2 | 3 | 4 | 5 | 6 | 7 | 8 |
|--------|---|---|---|---|---|---|---|---|
| **x1** | 1 | 3 | 5 | 6 | 8 | 7 | 2 | 4 |
| **x2** | 1 | 5 | 3 | 2 | 4 | 6 | 8 | 7 |
| **x3** | 1 | 8 | 7 | 2 | 3 | 5 | 4 | 6 |
| **x4** | 1 | 7 | 2 | 8 | 3 | 6 | 4 | 2 |

### Отбор особей начальной популяции для скрещивания:
Вычислим степень приспособленности (фитнес-функцию) всех особей в популяции. Фитнес-функция - длина маршрута, задаваемого особью.
Суммируем значения из матрицы на пересечении городов.

| Особь  | f(x)  |
|--------|-------|
| **x1** | 74    |
| **x2** | 102   |
| **x3** | 51    |
| **x4** | 208   |

#### Элитарный способ скрещивания: берем две самые сильные особи.

Таким образом, особи x1 (74) и x3(61) будут участвовать в скрещивании.

### Скрещивание особей начальной популяции:

#### Альтернативное кодирование:

| **x1** | 1 | 3 | 5 | 6 | 8 | 7 | 2 | 4 |
|--------|---|---|---|---|---|---|---|---|
| **x3** | 1 | 8 | 7 | 2 | 3 | 5 | 4 | 6 |

Перед скрещиванием особей применим альтернативную кодировку. Альтернативный код особи получается из ее натурального кода.

Составим таблицу для кодирования. В первой строке будет располагаться натуральный код особи, во второй - возрастающая перестановка от 1 до 8, а в третьей - номера позиций в этой перестановке, всегда начинающиеся с единицы.

| **x1** | 1 | 3 | 5 | 6 | 8 | 7 | 2 | 4 |
|--------|---|---|---|---|---|---|---|---|
| **N**  | 1 | 2 | 3 | 4 | 5 | 6 | 7 | 8 |
| **№**  | 1 | 2 | 3 | 4 | 5 | 6 | 7 | 8 |

Альтернативный код получается в результате прохода по элементам кода особи, поиска текущего элемента в возрастающей последовательности и его сопоставления с позицией.
В данном случае первый элемент кода особи равен 1, в возрастающей последовательности находится на 1 месте и соответствует позиции 1.

Запишем эту единицу, а также удалим ее сначала из первой строки, а затем из второй. 3 строку с позициями перенумеруем. Получившаяся таблица:

| **x1** | 3 | 5 | 6 | 8 | 7 | 2 | 4 |
|--------|---|---|---|---|---|---|---|
| **N**  | 2 | 3 | 4 | 5 | 6 | 7 | 8 |
| **№**  | 1 | 2 | 3 | 4 | 5 | 6 | 7 |

Следующий на очереди элемент - 3. Найдем его в возрастающей последовательности. Он находится на 2 месте и соответствует позиции 2.

Запишем 3 и удалим этот элемент из 1 и 2 строки, а также произведем повторную нумерацию 3 строки.

| **x1** | 5 | 6 | 8 | 7 | 2 | 4 |
|--------|---|---|---|---|---|---|
| **N**  | 2 | 4 | 5 | 6 | 7 | 8 |
| **№**  | 1 | 2 | 3 | 4 | 5 | 6 |

Следующий элемент для перевода в альтернативный код - 5. Найдем его в возрастающей последовательности и сопоставим с позицией. Получилось число 3.

Проделаем аналогичные операции с таблицей и получим новую:

| **x1** | 6 | 8 | 7 | 2 | 4 |
|--------|---|---|---|---|---|
| **N**  | 2 | 4 | 6 | 7 | 8 |
| **№**  | 1 | 2 | 3 | 4 | 5 |

Далее все аналогично. Число 6 соответствует позиции 3. Запишем 3 и продолжим.

| **x1** | 8 | 7 | 2 | 4 |
|--------|---|---|---|---|
| **N**  | 2 | 4 | 7 | 8 |
| **№**  | 1 | 2 | 3 | 4 |

Число 8 соответствует 4 позиции. Запишем 4.

| **x1** | 7 | 2 | 4 |
|--------|---|---|---|
| **N**  | 2 | 4 | 7 |
| **№**  | 1 | 2 | 3 |

Число 7 соответствует 3 позиции. Запишем 3.

| **x1** | 2 | 4 |
|--------|---|---|
| **N**  | 2 | 4 |
| **№**  | 1 | 2 |

Число 2 соответствует 1 позиции. Запишем 1.

| **x1** | 4 |
|--------|---|
| **N**  | 4 |
| **№**  | 1 |

И оставшееся число соответствует позиции 1. Позиция последнего числа всегда равна единице.

Получившийся альтернативный код особи x1: 12334311

#### Альтернативная кодировка особи x3:

Составим таблицу для особи x3:

| **x3** | 1 | 8 | 7 | 2 | 3 | 5 | 4 | 6 |
|--------|---|---|---|---|---|---|---|---|
| **N**  | 1 | 2 | 3 | 4 | 5 | 6 | 7 | 8 |
| **№**  | 1 | 2 | 3 | 4 | 5 | 6 | 7 | 8 |

После проведения аналогичных операций получим альтернативный код особи x3: 17611211

#### Скрещивание: 
Применим одноточечное скрещивание к особям.

| **x1** | 1 | 2 | 3 | 3 | 4 | 3 | 1 | 1 |
|--------|---|---|---|---|---|---|---|---|
| **x3** | 1 | 7 | 6 | 4 | 1 | 2 | 1 | 1 |
-----------------------------------------------------------------
Разделим х1 и х3 пополам. Для первого потомка: первая половина - х1, а вторая половина - х2. Для второго потомка: первая половина - х2, а вторая половина - х1.

|--------|---|---|---|---|---|---|---|---|
| **x5** | 1 | 2 | 3 | 3 | 1 | 2 | 1 | 1 |
| **x6** | 1 | 7 | 6 | 1 | 4 | 3 | 1 | 1 |

#### Мутация: 
Пусть мутация произошла с особью x6, тогда поменяем 1 на 4 разряде на 5 (максимальное число в кодировке, соотв. формуле n - i + 1, отсюда:
| **x6** | 1 | 7 | 6 | 5 | 4 | 3 | 1 | 1 |

Теперь декодируем получившиеся последовательности:

Перевод из альтернативной кодировки в нормальную осуществляется практически аналогично. Сначала составляется таблица:

| **x5** | 1 | 2 | 3 | 3 | 1 | 2 | 1 | 1 |
|--------|---|---|---|---|---|---|---|---|
| **N**  | 1 | 2 | 3 | 4 | 5 | 6 | 7 | 8 |
| **№**  | 1 | 2 | 3 | 4 | 5 | 6 | 7 | 8 |

Но в отличие от кодировки теперь ищется позиция и сопоставляется с элементом в возрастающей последовательности. 
В данном случае с единицей все предельно понятно.

По аналогии удалим столбец с единицей и перейдем к следующему элементу - 2:

| **x5** | 2 | 3 | 3 | 1 | 2 | 1 | 1 |
|--------|---|---|---|---|---|---|---|
| **N**  | 2 | 3 | 4 | 5 | 6 | 7 | 8 | 
| **№**  | 1 | 2 | 3 | 4 | 5 | 6 | 7 |

Найдем число 2 в последовательности позиций. Элементу 2 соответствует число 3 в возрастающей последовательности. Запишем 3 и продолжим.

Удалим число 2 из первой строки, число 3 из возрастающей последовательности и число 7 из последовательности с позициями и получим таблицу: 

| **x5** | 3 | 3 | 1 | 2 | 1 | 1 |
|--------|---|---|---|---|---|---|
| **N**  | 2 | 4 | 5 | 6 | 7 | 8 | 
| **№**  | 1 | 2 | 3 | 4 | 5 | 6 |

Числу 3 соответствует элемент 5.

| **x5** | 3 | 1 | 2 | 1 | 1 |
|--------|---|---|---|---|---|
| **N**  | 2 | 4 | 6 | 7 | 8 | 
| **№**  | 1 | 2 | 3 | 4 | 5 | 

Числу 3 соответствует элемент 6.

| **x5** | 1 | 2 | 1 | 1 |
|--------|---|---|---|---|
| **N**  | 2 | 4 | 7 | 8 | 
| **№**  | 1 | 2 | 3 | 4 |

Числу 1 соответствует элемент 2.

| **x5** | 2 | 1 | 1 |
|--------|---|---|---|
| **N**  | 4 | 7 | 8 | 
| **№**  | 1 | 2 | 3 |

Числу 2 соответствует элемент 7.

| **x5** | 1 | 1 |
|--------|---|---|
| **N**  | 4 | 8 |
| **№**  | 1 | 2 |

Числу 1 соответствует элемент 4.

| **x5** | 1   |
|--------|-----|
| **N**  | 8   |
| **№**  | 1   |

И, наконец, оставшейся единице соответствует число 8.

Получившийся натуральный код особи x5: 13562748
Натуральный код особи x6 после проведения аналогичной операции: 18765423

| **x5** | 1 | 3 | 5 | 6 | 2 | 7 | 4 | 8 |
|--------|---|---|---|---|---|---|---|---|
| **x6** | 1 | 8 | 7 | 6 | 5 | 4 | 2 | 3 |

#### Вычислим фитнес-функцию новых особей (посчитаем длину маршрута):

| Особь  | f(x) |
|--------|------|
| **x5** |  96  |
| **x6** |  174 |

Новое поколение будет состоять из особей, отобранных элитарным методом для скрещивания, и их потомков.

### I поколение

|        | 1 | 2 | 3 | 4 | 5 | 6 | 7 | 8 | f(x) |
|--------|---|---|---|---|---|---|---|---|------|
| **x1** | 1 | 3 | 5 | 6 | 8 | 7 | 2 | 4 | 74   |
| **x3** | 1 | 8 | 7 | 2 | 3 | 5 | 4 | 6 | 61   |
| **x5** | 1 | 3 | 5 | 6 | 2 | 7 | 4 | 8 | 96   |
| **x6** | 1 | 8 | 7 | 6 | 5 | 4 | 2 | 3 | 174  |

### Отбор родительских особей I поколения:

Элитарным методом отберем особей для скрещивания.

Особи x1 и x3 будут участвовать в скрещивании.

### Скрещивание особей I поколения:

Натуральная кодировка: 

| **x1** | 1 | 3 | 5 | 6 | 8 | 7 | 2 | 4 |
|--------|---|---|---|---|---|---|---|---
| **x3** | 1 | 8 | 7 | 2 | 3 | 5 | 4 | 6 |


Перед скрещиванием применим альтернативную кодировку:

| **x1** | 1 | 2 | 3 | 3 | 4 | 3 | 1 | 1 |
|--------|---|---|---|---|---|---|---|---
| **x3** | 1 | 7 | 6 | 1 | 1 | 2 | 1 | 1 |

Применим одноточечное скрещивание к особям.

| **x1** | 1 | 2 | 3 | 3 | 4 | 3 | 1 | 1 |
|--------|---|---|---|---|---|---|---|---|
| **x3** | 1 | 7 | 6 | 1 | 1 | 2 | 1 | 1 |
-----------------------------------------------------------------
Разделим х1 и х3 в пропорции 2 к 6. Для первого потомка: первые 2 позиции - х1, а последующие 6 - х3. Для второго потомка:  первые 2 позиции - х3, а последующие 6 - х1.

| **x7** | 1 | 2 | 6 | 1 | 1 | 2 | 1 | 1 |
|--------|---|---|---|---|---|---|---|---|
| **x8** | 1 | 7 | 3 | 3 | 4 | 3 | 1 | 1 |

#### Мутация: 
Пусть мутация произошла с особью x8, тогда поменяем 1 на 7 разряде на 2 (максимальное число в кодировке, соотв. формуле n - i + 1, отсюда:
| **x8** | 1 | 7 | 3 | 3 | 4 | 3 | 2 | 1 |

Декодируем получившиеся хромосомы:

| **x7** | 1 | 3 | 8 | 2 | 4 | 6 | 5 | 7 |
|--------|---|---|---|---|---|---|---|---|
| **x8** | 1 | 8 | 4 | 5 | 7 | 6 | 3 | 2 |

Вычислим фитнес-функции:

| Особь  | f(x)|
|--------|-----|
| **x7** | 104 |
| **x8** | 198 |

Новое II поколение будет состоять из особей, отобранных элитарным методом, и их потомков.


### II поколение

|        | 1 | 2 | 3 | 4 | 5 | 6 | 7 | 8 | f(x) |
|--------|---|---|---|---|---|---|---|---|------|
| **x1** | 1 | 3 | 5 | 6 | 8 | 7 | 2 | 4 | 74   |
| **x3** | 1 | 8 | 7 | 2 | 3 | 5 | 4 | 6 | 61   |
| **x7** | 1 | 3 | 8 | 2 | 4 | 6 | 5 | 7 | 104  |
| **x8** | 1 | 8 | 4 | 5 | 7 | 6 | 3 | 2 | 198  |

### Отбор родительских особей II поколения:

Натуральная кодировка: 

| **x1** | 1 | 3 | 5 | 6 | 8 | 7 | 2 | 4 |
|--------|---|---|---|---|---|---|---|---
| **x3** | 1 | 8 | 7 | 2 | 3 | 5 | 4 | 6 |


Перед скрещиванием применим альтернативную кодировку:

| **x1** | 1 | 2 | 3 | 3 | 4 | 3 | 1 | 1 |
|--------|---|---|---|---|---|---|---|---
| **x3** | 1 | 7 | 6 | 1 | 1 | 2 | 1 | 1 |

Применим одноточечное скрещивание к особям.

| **x1** | 1 | 2 | 3 | 3 | 4 | 3 | 1 | 1 |
|--------|---|---|---|---|---|---|---|---|
| **x3** | 1 | 7 | 6 | 1 | 1 | 2 | 1 | 1 |
-----------------------------------------------------------------
Разделим х1 и х3 в пропорции 6 к 2. Для первого потомка: первые 6 позиций - х1, а последующие 2 - х3. Для второго потомка:  первые 6 позиций - х3, а последующие 2 - х1.

| **x9** | 1 | 2 | 3 | 3 | 4 | 3 | 1 | 1 |
|--------|---|---|---|---|---|---|---|---|
| **x10** | 1 | 7 | 6 | 1 | 1 | 2 | 1 | 1 |

#### Мутация: 
Особи получились идентичными родителям, тогда поменяем 3 на 5 в 3 разряде у x9 и 1 на 3 в 5 разряде у x10, значение не должны привышать n - i + 1:
| **x9** | 1 | 2 | 5 | 3 | 4 | 3 | 1 | 1 |
|--------|---|---|---|---|---|---|---|---|
| **x10** | 1 | 7 | 6 | 1 | 3 | 2 | 1 | 1 |

Декодируем получившиеся хромосомы:

| **x9** | 1 | 3 | 7 | 5 | 8 | 6 | 2 | 4 |
|--------|---|---|---|---|---|---|---|---|
| **x10** | 1 | 8 | 7 | 2 | 5 | 4 | 3 | 6 |

Вычислим фитнес-функции:

| Особь  | f(x)|
|--------|-----|
| **x9** | 149 |
| **x10** | 111 |

### III поколение

|          | 1 | 2 | 3 | 4 | 5 | 6 | 7 | 8 | f(x) |
|----------|---|---|---|---|---|---|---|---|----|
| **x1** | 1 | 3 | 5 | 6 | 8 | 7 | 2 | 4 | 74   |
| **x3** | 1 | 8 | 7 | 2 | 3 | 5 | 4 | 6 | 61   |
| **x9**   | 1 | 3 | 7 | 5 | 8 | 6 | 2 | 4 | 149   |
| **x10**  | 1 | 8 | 7 | 2 | 5 | 4 | 3 | 6 | 111   |

Лидер популяции - особь x3.


### ОТВЕТ:
##### Найденный маршрут: 1-8-7-2-3-5-4-6-1
#### Длина маршрута: 61

### Правильный ответ:
##### Маршрут: 1-2-3-8-7-5-4-6-1
#### Длина маршрута: 33
